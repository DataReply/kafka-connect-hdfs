stages:
  - build
  - test
  - package

build_release:
  stage: package
  except:
    - master
  only:
    - tags
  before_script:
    - mkdir -p /root/.m2 && echo """<settings><proxies><proxy><id>http-proxy</id><active>true</active><protocol>http</protocol><host>$proxy_url</host><port>$proxy_port</port></proxy><proxy><id>https-proxy</id><active>true</active><protocol>https</protocol><host>$proxy_url</host><port>$proxy_port</port></proxy></proxies></settings>""" >> /root/.m2/settings.xml
  script:
    - export http_proxy=$proxy && export https_proxy=$ssl_proxy
    - cd $CI_PROJECT_DIR
    - mkdir build_temp
    - cd build_temp
    - python -c "from git import Repo;Repo.clone_from('https://github.com/apache/kafka', '$CI_PROJECT_DIR/build_temp/kafka')"
    - python -c "from git import Repo;Repo.clone_from('https://github.com/confluentinc/common', '$CI_PROJECT_DIR/build_temp/common')"
    - python -c "from git import Repo;Repo.clone_from('https://github.com/confluentinc/rest-utils', '$CI_PROJECT_DIR/build_temp/rest-utils')"
    - python -c "from git import Repo;Repo.clone_from('https://github.com/confluentinc/schema-registry', '$CI_PROJECT_DIR/build_temp/schema-registry')"
    - python -c "from git import Repo;Repo.clone_from('https://github.com/confluentinc/kafka-connect-storage-common', '$CI_PROJECT_DIR/build_temp/kafka-connect-storage-common')"
    - cd ..
#    - mvn package -DskipTests=true
    - sh assembly.sh
    - cp $CI_PROJECT_DIR/target/$PROJECT_NAME-4.0.0.jar /mnt/container-volumes/connect/kafka-connect-hdfs
  artifacts:
    name: "$PROJECT_NAME-$CI_COMMIT_TAG"
    # available at REPO_URL/builds/artifacts/<CI_COMMIT_TAG>/download?job=build_release
    paths:
      - "$CI_PROJECT_DIR/$PROJECT_NAME-$CI_COMMIT_TAG"